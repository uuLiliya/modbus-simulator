# 测试文档：使用Socket FD作为客户端标识

## 测试概述

本文档描述如何测试修改后的server.c，验证其使用socket文件描述符(fd)作为客户端唯一标识。

## 主要变更

1. **移除自增ID逻辑**：不再使用"Client_1", "Client_2"等序号
2. **使用socket fd**：直接使用accept()返回的文件描述符作为标识
3. **日志格式更新**：所有日志使用`[fd:X]`格式
4. **命令语法更新**：`send`命令现在使用fd而非客户端ID

## 编译

```bash
make clean
make all
```

应该无警告编译通过。

## 测试场景

### 1. 基本连接测试

**启动服务器：**
```bash
./build/server 8080
```

**预期输出：**
```
[服务器] 正在监听端口 8080（最大客户端数: 128）
[服务器] 输入 'help' 查看可用命令
```

**连接客户端：**
```bash
./build/client 127.0.0.1 8080
```

**服务器应显示：**
```
[服务器] [fd:5] 客户端已连接，来自 127.0.0.1:xxxxx（当前客户端总数: 1）
```

**客户端应显示：**
```
[服务器消息] [服务器通知] 欢迎，您的文件描述符为 5。
```

### 2. 多客户端并发测试

**同时连接3个客户端**

每个客户端应该收到不同的fd（如5, 6, 7）：

客户端1：
```
[服务器消息] [服务器通知] 欢迎，您的文件描述符为 5。
```

客户端2：
```
[服务器消息] [服务器通知] 欢迎，您的文件描述符为 6。
```

客户端3：
```
[服务器消息] [服务器通知] 欢迎，您的文件描述符为 7。
```

服务器应显示：
```
[服务器] [fd:5] 客户端已连接，来自 127.0.0.1:xxxxx（当前客户端总数: 1）
[服务器] [fd:6] 客户端已连接，来自 127.0.0.1:xxxxx（当前客户端总数: 2）
[服务器] [fd:7] 客户端已连接，来自 127.0.0.1:xxxxx（当前客户端总数: 3）
```

### 3. 消息回显测试

客户端发送消息"Hello"，应收到：
```
[服务器消息] [服务器回显][fd:5] Hello
```

服务器应显示：
```
[服务器] [fd:5] 消息：Hello
```

### 4. 服务器命令测试

#### list命令

在服务器终端输入：
```
list
```

预期输出：
```
[服务器] 当前连接的客户端列表：
  - [fd:5] (地址=127.0.0.1:xxxxx)
  - [fd:6] (地址=127.0.0.1:xxxxx)
[服务器] 总计：2 个客户端
```

#### send命令（新语法）

在服务器终端输入：
```
send 5 Hello Client
```

预期：
- 服务器显示：`[服务器] 已向 [fd:5] 发送消息: Hello Client`
- fd为5的客户端收到：`[服务器消息] [服务器] Hello Client`

#### broadcast命令

在服务器终端输入：
```
broadcast Hello Everyone
```

预期：
- 所有客户端都收到：`[服务器消息] [服务器广播] Hello Everyone`
- 服务器显示：`[服务器] 已广播消息给 N 个客户端`

### 5. 断开连接测试

客户端输入`quit`或关闭，服务器应显示：
```
[服务器] [fd:5] 已断开连接（地址 127.0.0.1:xxxxx，原因: 客户端关闭连接）（当前客户端总数: 0）
```

## 自动化测试

运行自动化测试脚本：

```bash
# 基本功能测试
bash tests/test_fd.sh

# 多客户端测试
bash tests/test_multi_clients.sh

# 服务器命令测试
bash tests/test_server_commands2.sh
```

所有测试应该通过。

## 验证要点

- ✅ 服务器不再使用"Client_1"等序号
- ✅ 所有日志使用`[fd:X]`格式
- ✅ 每个客户端的fd是唯一的socket文件描述符
- ✅ send命令语法改为`send <fd> <message>`
- ✅ 回显消息格式：`[服务器回显][fd:X] 消息内容`
- ✅ 欢迎消息包含fd：`欢迎，您的文件描述符为 X`
- ✅ 多客户端能正确区分不同的fd
- ✅ 所有功能保持完整（连接、回显、命令、广播等）

## 注意事项

1. fd的具体数值取决于操作系统和进程状态，通常从3或4开始（0,1,2被stdin/stdout/stderr占用）
2. 客户端断开后再连接可能复用之前的fd
3. 在后台运行或通过管道重定向stdin时，命令功能可能不可用（这是预期行为）
